# GNN для предсказания ширины запрещенной зоны TMDC

Проект реализует графовую нейронную сеть для расчета ширины запрещенной зоны (band gap) двумерных дихалькогенидов переходных металлов (TMDC). Используется набор данных из соревнования [IDAO-2022](https://github.com/HSE-LAMBDA/IDAO-2022). 

## Идея решения

1. Представить кристаллическую структуру как граф.
2. Узлы — атомы, ребра — пары атомов внутри радиуса `cutoff`.
3. Признаки узлов включают атомный номер и табличные свойства (группа, период, электроотрицательность, радиус).
4. Признаки ребер — расстояние и его гауссовое разложение (RBF).
5. Глобальное представление структуры получается через агрегацию (mean/max pooling).
6. Регрессионный модуль предсказывает band gap.

## Архитектура нейронной сети

В модели `TMDNet` используется последовательность слоев message passing:

- **Node embedding**: `Embedding(Z)` + MLP для непрерывных признаков атома.
- **MPNN block** (повторяется `L` раз):
  - edge MLP: `edge_attr -> hidden`
  - сообщение: `x_j + edge_emb`, далее MLP
  - агрегация по соседям с нормировкой на степень узла
  - residual-связь `out = relu(pre_out) + x`
- **Pooling**: конкатенация `mean` и `max` по узлам графа.
- **Regressor**: MLP до одного значения (band gap).

Последовательность вычислений:

1. Формирование признаков узлов и эмбеддинга атомного номера.
2. Проекция в скрытое пространство (Node MLP).
3. Многослойный message passing (`L` слоёв).
4. Пуллинг по узлам (mean + max).
5. Регрессионная голова (MLP) → band gap.

## Структура проекта


source/
  dataset.py        # обертки для списков графов
  featurization.py  # признаки атомов, RBF для расстояний
  graph.py          # построение графа из структуры
  model.py          # архитектура GNN
  train.py          # обучение и оценка
main.ipynb          # демонстрация обучения и инференса

## Ожидаемый формат данных

В `data_dir` (как в `IDAO-2022`):

- `targets.csv` с индексом id структуры и столбцом значений band gap  
- папка `structures/` со структурами `.json` (pymatgen `Structure`)  

## Быстрый запуск

1. Установить зависимости:
   - `numpy`, `pandas`, `pymatgen`, `matplotlib`, `scikit-learn` (для `train_test_split`)
2. Открыть `main.ipynb`
3. Указать путь к данным в переменной `DATA_PATH` и порог `EWT_EPSILON`
4. Запустить все ячейки

## Метрики

- **MSE/MAE** — стандартные метрики регрессии.
- **EwT (Energy within Threshold)** — доля структур, для которых ошибка `|pred - true| <= ε` (ε задается в `main.ipynb`).